import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, collection, query, onSnapshot, addDoc, doc, updateDoc, deleteDoc } from 'firebase/firestore';

// Main App component
const App = () => {
    // State to manage the current active menu
    const [activeMenu, setActiveMenu] = useState('panduan-umum');
    // State to store the list of certifications
    const [certifications, setCertifications] = useState([]);
    // State to manage the visibility of the certification name table
    const [showCertificationNameTable, setShowCertificationNameTable] = useState(false);
    // State to store the selected certification name
    const [selectedCertificationName, setSelectedCertificationName] = useState('');
    // State to store the list of available certification names (hardcoded for now)
    const [availableCertifications, setAvailableCertifications] = useState([]);
    // State for form fields
    const [formNamaSertifikasi, setFormNamaSertifikasi] = useState('');
    const [formTingkatSertifikasi, setFormTingkatSertifikasi] = useState('');
    const [formRelevansiSertifikasi, setFormRelevansiSertifikasi] = useState('');
    const [formTingkatSertifikasiLainnya, setFormTingkatSertifikasiLainnya] = useState('');
    const [formJenisSertifikasi, setFormJenisSertifikasi] = useState('');
    // State to store the certification being edited
    const [editingCertification, setEditingCertification] = useState(null);

    // State to manage Firebase instances
    const [db, setDb] = useState(null);
    const [auth, setAuth] = useState(null);
    const [userId, setUserId] = useState(null);
    const [isAuthReady, setIsAuthReady] = useState(false);

    // State for managing pop-up visibility on click for Nama Sertifikasi
    const [activeCertPopupIndex, setActiveCertPopupIndex] = useState(null);

    // State for Jenis Sertifikasi suggestions
    const [filteredJenisSuggestions, setFilteredJenisSuggestions] = useState([]);
    const [showJenisSuggestions, setShowJenisSuggestions] = useState(false);
    const jenisSertifikasiOptions = ["PBJ", "Bendahara", "PPK", "PPSPM", "Lainnya"];

    // State for connection status to Firestore
    const [connectionStatus, setConnectionStatus] = useState('connected'); // 'connected', 'disconnected', 'error'

    // State for Tingkat Sertifikasi explanation card
    const [selectedTingkatExplanation, setSelectedTingkatExplanation] = useState('');

    // Explanations for Tingkat Sertifikasi
    const tingkatExplanations = {
        "Dasar": "Sertifikasi pemula atau pengantar, biasanya tanpa prasyarat.",
        "Menengah": "Sertifikasi lanjutan yang mensyaratkan pengalaman atau pelatihan sebelumnya.",
        "Profesional": "Sertifikasi tingkat tinggi, seringkali diakui secara global dan memerlukan pengalaman profesional."
    };

    // Initialize Firebase and set up authentication listener
    useEffect(() => {
        const initializeFirebase = async () => {
            try {
                // Firebase configuration and app ID are provided globally
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

                // Initialize Firebase app
                const app = initializeApp(firebaseConfig);
                const firestoreDb = getFirestore(app);
                const firebaseAuth = getAuth(app);

                setDb(firestoreDb);
                setAuth(firebaseAuth);

                // Sign in with custom token or anonymously
                if (typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(firebaseAuth, __initial_auth_token);
                } else {
                    await signInAnonymously(firebaseAuth);
                }

                // Listen for auth state changes
                onAuthStateChanged(firebaseAuth, (user) => {
                    if (user) {
                        setUserId(user.uid);
                    } else {
                        setUserId(crypto.randomUUID()); // Anonymous user
                    }
                    setIsAuthReady(true);
                });

            } catch (error) {
                console.error("Error initializing Firebase:", error);
            }
        };

        initializeFirebase();
    }, []);

    // Fetch certifications from Firestore when auth is ready
    useEffect(() => {
        if (db && userId && isAuthReady) {
            const certificationsCollectionRef = collection(db, `artifacts/${__app_id}/users/${userId}/certifications`);
            const q = query(certificationsCollectionRef);

            const unsubscribe = onSnapshot(q, (snapshot) => {
                const certs = [];
                snapshot.forEach((doc) => {
                    certs.push({ id: doc.id, ...doc.data() });
                });
                setCertifications(certs);
                setConnectionStatus('connected'); // If snapshot is successful, connection is good
            }, (error) => {
                console.error("Error fetching certifications:", error);
                if (error.code === 'unavailable') {
                    setConnectionStatus('disconnected');
                } else {
                    setConnectionStatus('error'); // Generic error
                }
            });

            return () => unsubscribe(); // Cleanup listener on unmount
        }
    }, [db, userId, isAuthReady]);

    // Initialize certification names (hardcoded for now with descriptions)
    useEffect(() => {
        setAvailableCertifications([
            { name: "Microsoft Office Specialist (MOS)", description: "Sertifikasi keahlian dasar dalam penggunaan aplikasi Microsoft Office." },
            { name: "Sertifikat Digital Marketing Google", description: "Sertifikasi yang menunjukkan pemahaman dasar pemasaran digital dari Google." },
            { name: "Sertifikasi Dasar Pengadaan (LKPP)", description: "Sertifikasi pemula dalam proses pengadaan barang/jasa pemerintah." },
            { name: "Sertifikasi PBJ Level Menengah (LKPP)", description: "Sertifikasi lanjutan dalam pengadaan barang/jasa pemerintah." },
            { name: "PMP (Project Management Professional)", description: "Sertifikasi profesional yang diakui secara global dalam manajemen proyek." },
            { name: "CPA (Certified Public Accountant)", description: "Sertifikasi akuntan publik terkemuka." },
            { name: "CISA (Certified Information Systems Auditor)", description: "Sertifikasi untuk profesional audit sistem informasi." },
            { name: "TOGAF (The Open Group Architecture Framework)", description: "Sertifikasi dalam kerangka kerja arsitektur perusahaan." },
            { name: "Sertifikasi Auditor Profesional (BPK, BPKP, IIA)", description: "Sertifikasi untuk auditor profesional di sektor publik maupun swasta." },
            { name: "Sertifikasi Nasional Berbasis SKKNI Level 5 ke atas", description: "Sertifikasi kompetensi kerja yang diakui secara nasional berdasarkan Standar Kompetensi Kerja Nasional Indonesia." }
        ]);
    }, []);

    // Effect to handle clicks outside popups/suggestions to close them
    useEffect(() => {
        const handleClickOutside = (event) => {
            // Close Nama Sertifikasi popups if click is outside their icons and popups
            if (activeCertPopupIndex !== null && !event.target.closest('.info-icon-cert') && !event.target.closest('.info-popup-cert')) {
                setActiveCertPopupIndex(null);
            }
            // Close Jenis Sertifikasi suggestions if click is outside input or suggestions list
            if (showJenisSuggestions && !event.target.closest('#jenisSertifikasi') && !event.target.closest('.jenis-suggestions-list')) {
                setShowJenisSuggestions(false);
            }
        };

        document.addEventListener('click', handleClickOutside);
        return () => {
            document.removeEventListener('click', handleClickOutside);
        };
    }, [activeCertPopupIndex, showJenisSuggestions]);


    // Function to handle menu clicks
    const handleMenuClick = (menu) => {
        setActiveMenu(menu);
        // Clear editing state when switching menus
        setEditingCertification(null);
        // Clear form fields
        setFormNamaSertifikasi('');
        setFormTingkatSertifikasi('');
        setFormRelevansiSertifikasi('');
        setFormTingkatSertifikasiLainnya('');
        setFormJenisSertifikasi('');
        // Close all popups/suggestions
        setActiveCertPopupIndex(null);
        setShowJenisSuggestions(false);
        setSelectedTingkatExplanation(''); // Clear tingkat explanation card
    };

    // Function to handle "Buat Riwayat Sertifikasi" button click
    const handleCreateCertificationClick = () => {
        setEditingCertification(null); // Ensure no old data is pre-filled
        setFormNamaSertifikasi('');
        setFormTingkatSertifikasi('');
        setFormRelevansiSertifikasi('');
        setFormTingkatSertifikasiLainnya('');
        setFormJenisSertifikasi('');
        setActiveMenu('simulasi-pengisian');
        // Close all popups/suggestions
        setActiveCertPopupIndex(null);
        setShowJenisSuggestions(false);
        setSelectedTingkatExplanation(''); // Clear tingkat explanation card
    };

    // Function to handle "Pilih Sertifikasi" button click from the table
    const handleSelectCertification = (certName) => {
        setSelectedCertificationName(certName);
        setFormNamaSertifikasi(certName);
        setShowCertificationNameTable(false);
        setActiveCertPopupIndex(null); // Close cert popup after selection
    };

    // Function to handle Tingkat Sertifikasi dropdown change
    const handleTingkatSertifikasiChange = (e) => {
        const selectedValue = e.target.value;
        setFormTingkatSertifikasi(selectedValue);
        setSelectedTingkatExplanation(tingkatExplanations[selectedValue] || '');
    };

    // Function to handle form submission
    const handleSubmit = async (e) => {
        e.preventDefault();
        if (!db || !userId) {
            console.error("Firestore not initialized or user not authenticated.");
            return;
        }

        const certificationData = {
            namaSertifikasi: formNamaSertifikasi,
            tingkatSertifikasi: formTingkatSertifikasi,
            relevansiSertifikasi: formRelevansiSertifikasi,
            tingkatSertifikasiLainnya: formTingkatSertifikasiLainnya,
            jenisSertifikasi: formJenisSertifikasi,
            status: 'Diajukan', // Default status
            tanggalPengajuan: new Date().toISOString(),
        };

        try {
            if (editingCertification) {
                // Update existing certification
                await updateDoc(doc(db, `artifacts/${__app_id}/users/${userId}/certifications`, editingCertification.id), certificationData);
                alert('Riwayat sertifikasi berhasil diperbarui!');
            } else {
                // Add new certification
                await addDoc(collection(db, `artifacts/${__app_id}/users/${userId}/certifications`), certificationData);
                alert('Riwayat sertifikasi berhasil ditambahkan!');
            }
            // Clear form fields after submission
            setFormNamaSertifikasi('');
            setFormTingkatSertifikasi('');
            setFormRelevansiSertifikasi('');
            setFormTingkatSertifikasiLainnya('');
            setFormJenisSertifikasi('');
            setSelectedCertificationName('');
            setEditingCertification(null);
            setSelectedTingkatExplanation(''); // Clear explanation card
            setActiveMenu('riwayat-sertifikasi'); // Go back to list after save
        } catch (error) {
            console.error("Error saving document: ", error);
            alert('Gagal menyimpan riwayat sertifikasi.');
        }
    };

    // Function to handle "Lengkapi" (Edit) button click in the table
    const handleLengkapi = (cert) => {
        setEditingCertification(cert);
        setFormNamaSertifikasi(cert.namaSertifikasi);
        setFormTingkatSertifikasi(cert.tingkatSertifikasi);
        setFormRelevansiSertifikasi(cert.relevansiSertifikasi);
        setFormTingkatSertifikasiLainnya(cert.tingkatSertifikasiLainnya);
        setFormJenisSertifikasi(cert.jenisSertifikasi);
        setActiveMenu('simulasi-pengisian');
        // Set explanation for pre-filled tingkat
        setSelectedTingkatExplanation(tingkatExplanations[cert.tingkatSertifikasi] || '');
        // Close all popups/suggestions
        setActiveCertPopupIndex(null);
        setShowJenisSuggestions(false);
    };

    // Function to handle delete certification
    const handleDelete = async (id) => {
        if (!db || !userId) {
            console.error("Firestore not initialized or user not authenticated.");
            return;
        }
        if (window.confirm("Apakah Anda yakin ingin menghapus riwayat sertifikasi ini?")) { // Using window.confirm for simplicity
            try {
                const docRef = doc(db, `artifacts/${__app_id}/users/${userId}/certifications`, id);
                await deleteDoc(docRef);
                alert('Riwayat sertifikasi berhasil dihapus!');
                // If the deleted item was the one being edited, clear editing state
                if (editingCertification && editingCertification.id === id) {
                    setEditingCertification(null);
                    setFormNamaSertifikasi('');
                    setFormTingkatSertifikasi('');
                    setFormRelevansiSertifikasi('');
                    setFormTingkatSertifikasiLainnya('');
                    setFormJenisSertifikasi('');
                    setSelectedTingkatExplanation(''); // Clear explanation card
                }
            } catch (error) {
                console.error("Error deleting document:", error);
                alert('Gagal menghapus riwayat sertifikasi.');
            }
        }
    };

    return (
        <div className="flex h-screen font-sans" style={{ fontFamily: 'Inter, sans-serif' }}>
            {/* Custom Styles from index.html */}
            <style>
                {`
                body {
                    background-color: #111827; /* bg-gray-900 */
                    color: #d1d5db; /* text-gray-300 */
                }
                .sidebar-active {
                    background-color: #374151; /* bg-gray-700 */
                    color: #ffffff; /* text-white */
                    border-left: 3px solid #3b82f6; /* border-blue-500 */
                }
                .content-section {
                    display: none; /* Managed by React's conditional rendering */
                }
                .content-section.active {
                    display: block; /* Managed by React's conditional rendering */
                }
                .info-popup {
                    display: none; /* Default hidden */
                    position: absolute;
                    z-index: 50;
                    width: 350px;
                    background-color: #374151; /* bg-gray-700 */
                    border: 1px solid #4b5563; /* border-gray-600 */
                    border-radius: 0.5rem;
                    padding: 1rem;
                    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
                    pointer-events: none; /* Allows hover to pass through to element below if needed */
                }
                .info-popup.active {
                    display: block; /* Show when active */
                    pointer-events: auto; /* Allow interaction when active */
                }
                /* Positioning for Nama Sertifikasi popups within table cells */
                .info-popup-cert {
                    left: 100%; /* Position to the right of the parent */
                    top: 0;
                    margin-left: 8px; /* Small gap */
                }
                /* Styling for Jenis Sertifikasi suggestions list */
                .jenis-suggestions-list {
                    z-index: 51; /* Higher than other popups if needed */
                }
                /* Styling for the explanation card */
                .explanation-card {
                    background-color: #2d3748; /* bg-gray-800 */
                    border: 1px solid #4a5568; /* border-gray-700 */
                    border-radius: 0.5rem;
                    padding: 1rem;
                    margin-top: 0.5rem;
                    color: #e2e8f0; /* text-gray-200 */
                    font-size: 0.875rem; /* text-sm */
                    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
                }
                @keyframes pulse {
                    0%, 100% {
                        opacity: 1;
                        transform: scale(1);
                    }
                    50% {
                        opacity: 0.7;
                        transform: scale(1.1);
                    }
                }
                .pulse-animate {
                    animation: pulse 2s infinite;
                }
                `}
            </style>

            {/* Sidebar */}
            <aside className="w-64 bg-gray-800 text-gray-300 flex flex-col">
                <div className="h-16 flex items-center justify-center border-b border-gray-700">
                    <h1 className="text-2xl font-bold text-white">PARHATA</h1>
                </div>
                <nav className="flex-1 px-4 py-4">
                    <ul>
                        <li className="mb-2">
                            <button
                                onClick={() => handleMenuClick('panduan-umum')}
                                className={`sidebar-link flex items-center px-4 py-2.5 rounded-lg hover:bg-gray-700 transition-colors duration-200 w-full text-left ${
                                    activeMenu === 'panduan-umum' ? 'sidebar-active' : ''
                                }`}
                            >
                                <i className="fas fa-book-open w-6 mr-3"></i>
                                <span>Panduan Umum</span>
                            </button>
                        </li>
                        <li className="mb-2">
                            <button
                                onClick={() => handleMenuClick('riwayat-sertifikasi')}
                                className={`sidebar-link flex items-center px-4 py-2.5 rounded-lg hover:bg-gray-700 transition-colors duration-200 w-full text-left ${
                                    activeMenu === 'riwayat-sertifikasi' ? 'sidebar-active' : ''
                                }`}
                            >
                                <i className="fas fa-history w-6 mr-3"></i>
                                <span>Riwayat Sertifikasi</span>
                            </button>
                        </li>
                        <li className="mb-2">
                            <button
                                onClick={() => handleMenuClick('simulasi-pengisian')}
                                className={`sidebar-link flex items-center px-4 py-2.5 rounded-lg hover:bg-gray-700 transition-colors duration-200 w-full text-left ${
                                    activeMenu === 'simulasi-pengisian' ? 'sidebar-active' : ''
                                }`}
                            >
                                <i className="fas fa-edit w-6 mr-3"></i>
                                <span>Simulasi & Pengisian</span>
                            </button>
                        </li>
                    </ul>
                </nav>
                {/* Removed the User ID display as requested */}
            </aside>

            {/* Main Content */}
            <main className="flex-1 p-6 lg:p-10 overflow-y-auto bg-gray-900">

                {/* Display connection status */}
                {connectionStatus === 'disconnected' && (
                    <div className="bg-red-900/20 border border-red-500 text-red-300 px-4 py-3 rounded-lg relative mb-6" role="alert">
                        <strong className="font-bold">Koneksi Terputus!</strong>
                        <span className="block sm:inline ml-2">Tidak dapat terhubung ke server Firestore. Aplikasi mungkin beroperasi dalam mode offline. Silakan periksa koneksi internet Anda.</span>
                    </div>
                )}
                {connectionStatus === 'error' && (
                    <div className="bg-red-900/20 border border-red-500 text-red-300 px-4 py-3 rounded-lg relative mb-6" role="alert">
                        <strong className="font-bold">Terjadi Kesalahan!</strong>
                        <span className="block sm:inline ml-2">Terjadi kesalahan saat mengambil data dari Firestore. Silakan coba lagi nanti.</span>
                    </div>
                )}

                {/* 1. Panduan Umum Section */}
                {activeMenu === 'panduan-umum' && (
                    <section id="panduan-umum" className="content-section active">
                        <div className="bg-gray-800 p-8 rounded-xl shadow-lg">
                            <h2 className="text-3xl font-bold text-white mb-4">Panduan Umum Portofolio Sertifikasi</h2>
                            <p className="mb-6 text-gray-400">Selamat datang di modul Portofolio Riwayat Sertifikasi. Modul ini bertujuan untuk mendokumentasikan dan menilai rekam jejak sertifikasi Anda secara sistematis.</p>
                            
                            <div className="space-y-4">
                                <div>
                                    <h3 className="text-xl font-semibold text-teal-400 mb-2">Tujuan Pengisian</h3>
                                    <p>Pengisian portofolio ini penting untuk keperluan manajemen talenta, pengembangan karir, dan proses seleksi. Data yang akurat dan lengkap akan membantu sistem dalam memberikan penilaian yang objektif.</p>
                                </div>
                                <div>
                                    <h3 className="text-xl font-semibold text-teal-400 mb-2">Dasar Hukum</h3>
                                    <p>Pengelolaan data dan penilaian sertifikasi didasarkan pada peraturan yang berlaku terkait sertifikasi profesional dan pengembangan kompetensi.</p>
                                </div>
                                <div>
                                    <h3 className="text-xl font-semibold text-teal-400 mb-2">Sinkronisasi Data</h3>
                                    <p>Perlu diketahui bahwa beberapa data sertifikasi Anda mungkin ditarik secara otomatis dari sistem terkait. Sinkronisasi ini dilakukan oleh sistem PARHATA secara berkala. Pastikan data Anda selalu ter-update.</p>
                                </div>
                            </div>
                        </div>
                    </section>
                )}

                {/* 2. Riwayat Sertifikasi Section */}
                {activeMenu === 'riwayat-sertifikasi' && (
                    <section id="riwayat-sertifikasi" className="content-section active">
                        <h2 className="text-3xl font-bold text-white mb-2">Riwayat Sertifikasi</h2>
                        <p className="text-gray-400 mb-6">Berikut adalah daftar riwayat sertifikasi Anda.</p>

                        <div className="bg-blue-900/20 border border-blue-500 text-blue-300 px-4 py-3 rounded-lg relative mb-6" role="alert">
                            <strong className="font-bold">Informasi Penting!</strong>
                            <span className="block sm:inline ml-2">Data awal mungkin ditarik dari sistem lain. Klik tombol <b className="text-yellow-400">Lengkapi</b> untuk mengisi data Relevansi dan Tipe Sertifikasi.</span>
                        </div>

                        <div className="bg-gray-800 rounded-xl shadow-lg overflow-hidden">
                            <div className="p-4">
                                <div className="flex justify-between items-center">
                                    <div>
                                        <button className="bg-gray-700 text-white px-4 py-2 rounded-lg text-sm">Semua</button>
                                        <button className="bg-gray-900 text-gray-400 px-4 py-2 rounded-lg text-sm ml-2">Disetujui 0</button>
                                        <button className="bg-gray-900 text-gray-400 px-4 py-2 rounded-lg text-sm ml-2">Ditolak 0</button>
                                        <button className="bg-gray-900 text-gray-400 px-4 py-2 rounded-lg text-sm ml-2">Diajukan {certifications.filter(c => c.status === 'Diajukan').length}</button>
                                    </div>
                                    <div className="relative">
                                        <input type="search" placeholder="Search" className="bg-gray-700 rounded-lg pl-10 pr-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-300"/>
                                        <i className="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                    </div>
                                </div>
                            </div>
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm text-left text-gray-400">
                                    <thead className="text-xs text-gray-300 uppercase bg-gray-700/50">
                                        <tr>
                                            <th scope="col" className="px-6 py-3">Nama Sertifikasi</th>
                                            <th scope="col" className="px-6 py-3">Tingkat Sertifikasi</th>
                                            <th scope="col" className="px-6 py-3">Relevansi</th>
                                            <th scope="col" className="px-6 py-3">Tingkat Lainnya</th>
                                            <th scope="col" className="px-6 py-3">Jenis Sertifikasi</th>
                                            <th scope="col" className="px-6 py-3">Status</th>
                                            <th scope="col" className="px-6 py-3 text-center">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {certifications.length > 0 ? (
                                            certifications.map((cert) => (
                                                <tr key={cert.id} className="border-b border-gray-700">
                                                    <td className="px-6 py-4 font-medium text-white">{cert.namaSertifikasi}</td>
                                                    <td className="px-6 py-4">{cert.tingkatSertifikasi}</td>
                                                    <td className="px-6 py-4">{cert.relevansiSertifikasi}</td>
                                                    <td className="px-6 py-4">{cert.tingkatSertifikasiLainnya}</td>
                                                    <td className="px-6 py-4">{cert.jenisSertifikasi}</td>
                                                    <td className="px-6 py-4">
                                                        <span className={`
                                                            ${cert.status === 'Diajukan' ? 'bg-yellow-900 text-yellow-300' :
                                                              cert.status === 'Disetujui' ? 'bg-green-900 text-green-300' :
                                                              'bg-red-900 text-red-300'}
                                                            text-xs font-medium me-2 px-2.5 py-0.5 rounded-full
                                                        `}>
                                                            {cert.status}
                                                        </span>
                                                    </td>
                                                    <td className="px-6 py-4 text-center">
                                                        <button
                                                            onClick={() => handleLengkapi(cert)}
                                                            className="font-medium text-blue-500 hover:underline mr-4"
                                                        >
                                                            <i className="fas fa-edit mr-1"></i>Lengkapi
                                                        </button>
                                                        <button
                                                            onClick={() => handleDelete(cert.id)}
                                                            className="font-medium text-red-500 hover:underline"
                                                        >
                                                            <i className="fas fa-trash-alt mr-1"></i>Hapus
                                                        </button>
                                                    </td>
                                                </tr>
                                            ))
                                        ) : (
                                            <tr>
                                                <td colSpan="7" className="px-6 py-4 text-center text-gray-500">
                                                    Belum ada riwayat sertifikasi. Klik "Buat Riwayat Sertifikasi" untuk menambahkan.
                                                </td>
                                            </tr>
                                        )}
                                    </tbody>
                                </table>
                            </div>
                            <div className="p-4 text-right">
                                <button
                                    onClick={handleCreateCertificationClick}
                                    className="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition duration-300 ease-in-out transform hover:scale-105"
                                >
                                    Buat Riwayat Sertifikasi
                                </button>
                            </div>
                        </div>
                    </section>
                )}

                {/* 3. Simulasi & Pengisian Section */}
                {activeMenu === 'simulasi-pengisian' && (
                    <section id="simulasi-pengisian" className="content-section active">
                        <div className="flex justify-between items-center mb-6">
                            <div>
                                <h2 className="text-3xl font-bold text-white">
                                    {editingCertification ? 'Edit Riwayat Sertifikasi' : 'Create Riwayat Sertifikasi'}
                                </h2>
                                <p className="text-gray-400">Silakan lengkapi data berikut dengan benar.</p>
                            </div>
                            {editingCertification && (
                                <button
                                    onClick={() => handleDelete(editingCertification.id)}
                                    className="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200"
                                >
                                    <i className="fas fa-trash-alt mr-2"></i>Delete
                                </button>
                            )}
                        </div>

                        <div className="bg-gray-800 p-8 rounded-xl shadow-lg">
                            <form onSubmit={handleSubmit} className="space-y-6">
                                <div>
                                    <label htmlFor="namaSertifikasi" className="block mb-2 text-sm font-medium text-gray-300">
                                        Nama Sertifikasi<span className="text-red-500">*</span>
                                    </label>
                                    <input
                                        type="text"
                                        id="namaSertifikasi"
                                        className="bg-gray-700 border border-gray-600 text-gray-300 text-sm rounded-lg block w-full p-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        placeholder="Ketik nama sertifikasinya"
                                        value={formNamaSertifikasi}
                                        onChange={(e) => setFormNamaSertifikasi(e.target.value)}
                                        onClick={() => setShowCertificationNameTable(true)}
                                        required
                                    />
                                    {showCertificationNameTable && (
                                        <div className="mt-4 bg-gray-700 rounded-lg shadow-lg p-4 max-h-60 overflow-y-auto">
                                            <h3 className="text-lg font-semibold text-teal-300 mb-3">Pilih Nama Sertifikasi</h3>
                                            <table className="min-w-full divide-y divide-gray-600">
                                                <thead className="bg-gray-600">
                                                    <tr>
                                                        <th className="px-4 py-2 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Nama Sertifikasi</th>
                                                        <th className="px-4 py-2 text-right text-xs font-medium text-gray-300 uppercase tracking-wider">Aksi</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y divide-gray-700">
                                                    {availableCertifications.map((cert, index) => (
                                                        <tr key={index} className="hover:bg-gray-600">
                                                            <td className="px-4 py-2 whitespace-nowrap text-sm text-gray-200 relative">
                                                                {cert.name}
                                                                <i className="fas fa-info-circle text-blue-400 ml-1 cursor-pointer info-icon info-icon-cert"
                                                                   onClick={(e) => {
                                                                       e.stopPropagation(); // Prevent click from bubbling up
                                                                       setActiveCertPopupIndex(activeCertPopupIndex === index ? null : index);
                                                                   }}></i>
                                                                <div className={`info-popup info-popup-cert ${activeCertPopupIndex === index ? 'active' : ''}`}>
                                                                    <h4 className="font-bold text-white mb-2">Deskripsi Sertifikasi</h4>
                                                                    <p className="text-gray-200 text-sm">{cert.description}</p>
                                                                </div>
                                                            </td>
                                                            <td className="px-4 py-2 whitespace-nowrap text-right text-sm font-medium">
                                                                <button
                                                                    type="button"
                                                                    onClick={() => handleSelectCertification(cert.name)}
                                                                    className="text-teal-400 hover:text-teal-300"
                                                                >
                                                                    Pilih
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    )}
                                </div>

                                <div className="grid md:grid-cols-2 gap-6">
                                    <div>
                                        <label htmlFor="tingkatSertifikasi" className="block mb-2 text-sm font-medium text-gray-300">
                                            Tingkat Sertifikasi <span className="text-red-500">*</span>
                                        </label>
                                        <select
                                            id="tingkatSertifikasi"
                                            className="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"
                                            value={formTingkatSertifikasi}
                                            onChange={handleTingkatSertifikasiChange}
                                            required
                                        >
                                            <option value="">Pilih Tingkat</option>
                                            <option value="Dasar">Dasar</option>
                                            <option value="Menengah">Menengah</option>
                                            <option value="Profesional">Profesional</option>
                                        </select>
                                        {selectedTingkatExplanation && (
                                            <div className="explanation-card">
                                                <p>{selectedTingkatExplanation}</p>
                                            </div>
                                        )}
                                        <p className="mt-2 text-xs text-gray-500">Silakan pilih tingkat sertifikasi.</p>
                                    </div>

                                    <div>
                                        <label htmlFor="relevansiSertifikasi" className="block mb-2 text-sm font-medium text-gray-300">
                                            Relevansi Sertifikasi <span className="text-red-500">*</span>
                                            <i className="fas fa-info-circle text-blue-400 ml-1 cursor-pointer info-icon"></i>
                                            <div className="info-popup">
                                                <h4 className="font-bold text-white mb-2">Keterangan Relevansi Sertifikasi</h4>
                                                <ul className="list-disc list-inside space-y-1 text-sm">
                                                    <li><b className="text-gray-200">Tidak Relevan:</b> Tidak berkaitan langsung dengan bidang pekerjaan saat ini.</li>
                                                    <li><b className="text-gray-200">Sebagian Relevan:</b> Sebagian materi atau keahlian mendukung bidang pekerjaan saat ini.</li>
                                                    <li><b className="text-gray-200">Sangat Relevan:</b> Sertifikasi sepenuhnya mendukung dan relevan dengan bidang pekerjaan saat ini.</li>
                                                </ul>
                                            </div>
                                        </label>
                                        <select
                                            id="relevansiSertifikasi"
                                            className="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"
                                            value={formRelevansiSertifikasi}
                                            onChange={(e) => setFormRelevansiSertifikasi(e.target.value)}
                                            required
                                        >
                                            <option value="">Pilih Relevansi</option>
                                            <option value="Tidak Relevan">Tidak Relevan</option>
                                            <option value="Sebagian Relevan">Sebagian Relevan</option>
                                            <option value="Sangat Relevan">Sangat Relevan</option>
                                        </select>
                                        <p className="mt-2 text-xs text-gray-500">Silakan pilih relevansi sertifikasi dengan pekerjaan Anda.</p>
                                    </div>
                                </div>

                                <div className="grid md:grid-cols-2 gap-6">
                                    <div>
                                        <label htmlFor="tingkatSertifikasiLainnya" className="block mb-2 text-sm font-medium text-gray-300">
                                            Tingkat Sertifikasi Lainnya <span className="text-red-500">*</span>
                                        </label>
                                        <select
                                            id="tingkatSertifikasiLainnya"
                                            className="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"
                                            value={formTingkatSertifikasiLainnya}
                                            onChange={(e) => setFormTingkatSertifikasiLainnya(e.target.value)}
                                            required
                                        >
                                            <option value="">Pilih Tingkat</option>
                                            <option value="Nasional">Nasional</option>
                                            <option value="Internasional">Internasional</option>
                                            <option value="Lokal">Lokal</option>
                                        </select>
                                        <p className="mt-2 text-xs text-gray-500">Silakan pilih tingkat sertifikasi (misal: Nasional, Internasional).</p>
                                    </div>

                                    <div className="relative"> {/* Add relative for absolute positioning of suggestions */}
                                        <label htmlFor="jenisSertifikasi" className="block mb-2 text-sm font-medium text-gray-300">
                                            Jenis Sertifikasi <span className="text-red-500">*</span>
                                        </label>
                                        <input
                                            type="text"
                                            id="jenisSertifikasi"
                                            className="bg-gray-700 border border-gray-600 text-gray-300 text-sm rounded-lg block w-full p-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            placeholder="Ketik jenis sertifikasinya (misal: PBJ, PPK)"
                                            value={formJenisSertifikasi}
                                            onChange={(e) => {
                                                const inputValue = e.target.value;
                                                setFormJenisSertifikasi(inputValue);
                                                if (inputValue.length > 0) {
                                                    const filtered = jenisSertifikasiOptions.filter(option =>
                                                        option.toLowerCase().includes(inputValue.toLowerCase())
                                                    );
                                                    setFilteredJenisSuggestions(filtered);
                                                    setShowJenisSuggestions(true);
                                                } else {
                                                    setFilteredJenisSuggestions(jenisSertifikasiOptions); // Show all if input is empty
                                                    setShowJenisSuggestions(true);
                                                }
                                            }}
                                            onFocus={() => {
                                                if (formJenisSertifikasi.length > 0) {
                                                    const filtered = jenisSertifikasiOptions.filter(option =>
                                                        option.toLowerCase().includes(formJenisSertifikasi.toLowerCase())
                                                    );
                                                    setFilteredJenisSuggestions(filtered);
                                                } else {
                                                    setFilteredJenisSuggestions(jenisSertifikasiOptions); // Show all if input is empty on focus
                                                }
                                                setShowJenisSuggestions(true);
                                            }}
                                            onBlur={() => {
                                                // Delay hiding to allow click event on suggestions to fire
                                                setTimeout(() => setShowJenisSuggestions(false), 100);
                                            }}
                                            required
                                        />
                                        {showJenisSuggestions && filteredJenisSuggestions.length > 0 && (
                                            <div className="absolute z-10 w-full bg-gray-700 border border-gray-600 rounded-lg shadow-lg mt-1 max-h-40 overflow-y-auto jenis-suggestions-list">
                                                {filteredJenisSuggestions.map((suggestion, idx) => (
                                                    <div
                                                        key={idx}
                                                        className="px-4 py-2 cursor-pointer hover:bg-gray-600 text-gray-200"
                                                        onMouseDown={() => { // Use onMouseDown to prevent onBlur from firing first
                                                            setFormJenisSertifikasi(suggestion);
                                                            setShowJenisSuggestions(false);
                                                        }}
                                                    >
                                                        {suggestion}
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                        <p className="mt-2 text-xs text-gray-500">Ketik jenis sertifikasinya (misal: PBJ, Bendahara, PPK, PPSPM, Lainnya).</p>
                                    </div>
                                </div>

                                <div className="mt-8 flex items-center gap-4">
                                    <button
                                        type="submit"
                                        className="text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:ring-blue-800 font-medium rounded-lg text-sm px-5 py-2.5 transition-colors duration-200"
                                    >
                                        {editingCertification ? 'Simpan Perubahan' : 'Simpan Riwayat Sertifikasi'}
                                    </button>
                                    <button
                                        type="button"
                                        onClick={() => handleMenuClick('riwayat-sertifikasi')}
                                        className="text-gray-300 bg-transparent hover:bg-gray-700 border border-gray-600 font-medium rounded-lg text-sm px-5 py-2.5 transition-colors duration-200"
                                    >
                                        Batal
                                    </button>
                                </div>
                            </form>
                        </div>
                    </section>
                )}
            </main>
        </div>
    );
};

export default App;
